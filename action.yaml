name: "Accuknox IAC scanner"
description: "Run Accuknox infrastructure as code (IAC) scan on the repository"

branding:
  icon: "shield"
  color: "purple"

inputs:
  accuknox_token:
    description: "token for authenticating with CSPM panel"
    required: true
  accuknox_label:
    description: "label in AccuKnox SaaS for scan results"
    required: true
  accuknox_endpoint:
    description: "CSPM panel endpoint URL"
    required: true
  directory:
    description: "directory with infrastructure code to scan"
    required: false
    default: "."
  file:
    description: "specify a file for scanning; cannot be used with directory input."
    required: false
    default: ""
  compact:
    description: "do not display code blocks in output"
    required: false
    default: true
  quiet:
    description: "display only failed checks"
    required: false
    default: true
  soft_fail:
    description: "do not return an error code if there are failed checks"
    required: false
    default: false
  framework:
    description: "run only on a specific infrastructure, Kubernetes or Terraform"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Run Accuknox IAC scanner
      shell: bash
      env:
        ACCUKNOX_TOKEN: ${{ inputs.accuknox_token }}
        ACCUKNOX_LABEL: ${{ inputs.accuknox_label }}
        ACCUKNOX_ENDPOINT: ${{ inputs.accuknox_endpoint }}
        DIRECTORY: ${{ inputs.directory }}
        FILE: ${{ inputs.file }}
        COMPACT: ${{ inputs.compact }}
        QUIET: ${{ inputs.quiet }}
        SOFT_FAIL: ${{ inputs.soft_fail }}
        FRAMEWORK: ${{ inputs.framework }}
      run: |
        if [ -z "$ACCUKNOX_TOKEN" ] || [ -z "$ACCUKNOX_LABEL" ] || [ -z "$ACCUKNOX_ENDPOINT" ]; then
          echo "error: ACCUKNOX_TOKEN, ACCUKNOX_LABEL, and ACCUKNOX_ENDPOINT must be set!"
          exit 1
        fi

        echo "Downloading Accuknox ASPM Scanner..."
        curl -L https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.13.4/accuknox-aspm-scanner -o accuknox-aspm-scanner
        chmod +x accuknox-aspm-scanner

        CMD_ARGS=""
        [ -n "$FILE" ] && CMD_ARGS="$CMD_ARGS --file $FILE"
        [ -n "$DIRECTORY" ] && CMD_ARGS="$CMD_ARGS --directory $DIRECTORY"
        [ "$COMPACT" = "true" ] && CMD_ARGS="$CMD_ARGS --compact"
        [ "$QUIET" = "true" ] && CMD_ARGS="$CMD_ARGS --quiet"
        [ -n "$FRAMEWORK" ] && CMD_ARGS="$CMD_ARGS --framework $FRAMEWORK"

        SOFT_FAIL_ARG=""
        [ "$SOFT_FAIL" = "true" ] && SOFT_FAIL_ARG="--softfail"

        echo ./accuknox-aspm-scanner scan $SOFT_FAIL_ARG iac --command "$CMD_ARGS" --container-mode --repo-url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git" --repo-branch "${GITHUB_REF#refs/heads/}"
        ./accuknox-aspm-scanner scan $SOFT_FAIL_ARG iac --command "$CMD_ARGS" --container-mode --repo-url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git" --repo-branch "${GITHUB_REF#refs/heads/}"